<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Rover Control (Press & Hold)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root { --btn: #202530; --btnActive: #2e7d32; --stop: #b71c1c; }
    body { font-family: system-ui, Arial, sans-serif; background:#0b0e13; color:#e7eaf0; text-align:center; }
    h1 { font-weight:600; margin: 18px 0 8px; }
    .grid {
      display:grid; gap:12px; justify-content:center; align-items:center;
      grid-template-columns: 120px 120px 120px; margin: 24px auto; width:max-content;
    }
    button {
      width:120px; height:60px; font-size:18px; font-weight:600;
      border-radius:12px; border:1px solid #3a3f4b; background:var(--btn);
      color:#e7eaf0; cursor:pointer; transition: transform .02s ease-in-out;
      touch-action: none;
    }
    button:active { transform: scale(0.98); }
    .stop { grid-column: 1 / span 3; background: var(--stop); border-color:#802323; }
    .active { background: var(--btnActive) !important; border-color:#255a27 !important; }
    .rowspacer { height:12px; }
    .speed { margin-top: 4px; font-size:14px; opacity:.85; }
    input[type=range] { width: 240px; }
    footer { opacity:.6; font-size:12px; margin-top:12px; }
  </style>
</head>
<body>
  <h1>Rover Control</h1>
  <div class="speed">
    Speed: <span id="speedVal">70</span>
    <br/>
    <input id="speed" type="range" min="30" max="100" value="70" step="5"/>
  </div>

  <div class="grid">
    <div></div>
    <button id="forward">Forward</button>
    <div></div>

    <button id="left">Left</button>
    <div class="rowspacer"></div>
    <button id="right">Right</button>

    <div></div>
    <button id="backward">Backward</button>
    <div></div>

    <button id="stop" class="stop">STOP</button>
  </div>

  <footer>Press & hold to move. Releasing, switching tabs, or closing will STOP.</footer>

    <script>
        const btns = {
            forward: document.getElementById("forward"),
            backward: document.getElementById("backward"),
            left: document.getElementById("left"),
            right: document.getElementById("right"),
            stop: document.getElementById("stop"),
        };
        const speed = document.getElementById("speed");
        const speedVal = document.getElementById("speedVal");

        let active = null;
        let inFlight = false;

        function api(path, payload={}) {
            return fetch(path, {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify(payload)
            });
        }

        function start(dir) {
            if (inFlight && active === dir) return;
            inFlight = true;
            active = dir;
            for (const k in btns) btns[k].classList.remove("active");
            if (btns[dir]) btns[dir].classList.add("active");
            api("/control", {direction: dir, state: "start", speed: Number(speed.value)})
            .finally(()=>{ inFlight = false; });
        }

        function stopAll() {
            active = null;
            for (const k in btns) btns[k].classList.remove("active");
            api("/control", {state: "stop"});
        }

        function bindPressAndHold(el, dir) {
            const down = (e) => { e.preventDefault(); start(dir); };
            const up   = (e) => { e.preventDefault(); if (active === dir) stopAll(); };
            el.addEventListener("pointerdown", down);
            window.addEventListener("pointerup", up);
            window.addEventListener("pointercancel", up);
        }

        // Attach mouse/touch handlers
        bindPressAndHold(btns.forward, "forward");
        bindPressAndHold(btns.backward, "backward");
        bindPressAndHold(btns.left, "left");
        bindPressAndHold(btns.right, "right");

        btns.stop.addEventListener("click", (e)=>{ e.preventDefault(); stopAll(); });

        // --------- NEW: Keyboard bindings ---------
        const keyMap = {
            "w": "forward", "ArrowUp": "forward",
            "a": "left",    "ArrowLeft": "left",
            "s": "backward","ArrowDown": "backward",
            "d": "right",   "ArrowRight": "right",
            " ": "stop" // space bar = stop
        };

        document.addEventListener("keydown", (e) => {
            const dir = keyMap[e.key];
            if (dir && !active) {
            if (dir === "stop") stopAll();
            else start(dir);
            e.preventDefault();
            }
        });

        document.addEventListener("keyup", (e) => {
            const dir = keyMap[e.key];
            if (dir && dir !== "stop" && active === dir) {
            stopAll();
            e.preventDefault();
            }
        });
        // ------------------------------------------

        document.addEventListener("visibilitychange", ()=> {
            if (document.hidden) stopAll();
        });
        window.addEventListener("beforeunload", stopAll);

        speed.addEventListener("input", ()=>{
            speedVal.textContent = speed.value;
            if (active) api("/control", {direction: active, state: "start", speed: Number(speed.value)});
        });
    </script>
</body>
</html>
